#!/bin/sh
# ACQ2006B_TOP_01_01_ff_ff_ff_ff

if [ -e /mnt/local/fmc-scan.conf ]; then
	echo +++ fmc-scan using /mnt/local/fmc-scan.conf
	source /mnt/local/fmc-scan.conf
fi
if [ "$FMC_SCAN_FPGA" = "" ]; then
	echo ERROR: FMC_SCAN_FPGA not set
	exit 1
fi
if [ "$FMC_SCAN_SITES" = "" ]; then
	echo ERROR: FMC_SCAN_SITES not set
	exit 1
fi
scan_done=/var/run/fmc-scan-done
if [ -e $scan_done ]; then
	echo  $scan_done exists, looks like the scan has already completed
	exit 0
fi
mkdir -p /dev/sites

let module_count=0

for PRD in /dev/gpio/*present
do
	_PRDx=${PRD#/dev/gpio/fmc}
	if [ "$_PRDx" = "$PRD" ]; then
		_PRDx=${PRD#/dev/gpio/pmod}				
	fi
	if [ "$_PRDx" = "$PRD" ]; then
		echo ERROR $PRD not supported
		exit 1
	fi
	site=${_PRDx%_present}
	if [ $(cat $PRD) -ne 0 ]; then
		# PMODS are faked .. don't try make them again0
		if [ ! -e /dev/sites/$site ]; then  
			mkdir /dev/sites/$site
			let BUS=$site+1
			# mtca shim puts the eeprom at non-standard address
			for ba in 0050 0051 0052
			do
				eeprom=/sys/bus/i2c/devices/${BUS}-${ba}/eeprom
				if [ -e ${eeprom} ]; then
					ln -s ${eeprom} /dev/sites/$site
					break
				fi
			done
			echo 1 >/dev/gpio/LED/FMC${site}_R
		fi
		let module_count=$module_count+1	
	fi
done

SITES="sites="
GOOD_SITES="good_sites="

aappend() {
	case $1 in
	*=) echo $1$2;;
	*)  echo $1,$2;;
	esac
}

get_fpga_spec() {
#generated from filename   : ACQ2006_TOP_02_02_ff_ff_ff_40
# pick out the filename and remove leading _ (then mismatches are by site#)
	xiloader $* 2>&1 | grep generated | awk '{ print $5 }' | sed -e 's/_//' | sed -e 's/KMCUA/KMCU/'
}

let site_count=0
MTYPES=""

#acq2006_006> cat /dev/sites/5/details 
#FRU_MAN="D-TACQ Solutions"
#FRU_PROD_NAME="AO421ELF"
#FRU_SERIAL="E42100001"
#FRU_PART_NUM="AO421ELF"
# and the new ones
#M=f0
#N=40

decode_fru_success=0


decode_fru() {
	
	site=$1
	details=$2
	sdir=/etc/acq400/$site
	
	mkdir -p $sdir
	echo -n "++ decode FRU EEPROM site $site "

	FRU_MAN=xx
	FRU_PROD_NAME=xx
	FRU_SERIAL=xx
	FRU_PART_NUM=xx
	FRU_MTYPE=xx
	FRU_NCHAN=xx
	M=x
	N=x		
		
	nchan=4
	source $details
	mn=$(echo $FRU_PART_NUM | cut -d\  -f 2-  )
	if [ "$mn" != "$FRU_PART_NUM" ]; then
#		echo FRU_PART_NUM \"$FRU_PART_NUM\" \"$mn\"
		eval $mn
	fi
	
	if [ "$N" = "x" -o "M" = "x" ]; then
		decode_fru_success=0
		echo ERROR: obsolete EEPROM please contact D-TACQ for update
		return		
	fi
	
	echo $N > $sdir/NCHAN
	echo $M > $sdir/MTYPE
	echo $FRU_SERIAL > $sdir/SERIAL
	echo "$FRU_MAN" > $sdir/MANUFACTURER	
	echo $FRU_PART_NUM > $sdir/PART_NUM	

	_IFS=$IFS
	IFS='-'
	let ii=0
	for field in $FRU_PART_NUM
	do
#		echo decode FRU_PART_NUM: $FRU_PART_NUM: ii $ii field $field
		case $ii in
		0) [ -e $sdir/MODEL ] || echo $field > $sdir/MODEL;;
		1) nchan=$(echo $field | sed -e 's/[^0-9]//g')		
		   [ -e $sdir/NCHAN ] || echo $nchan  > $sdir/NCHAN;;
		2) echo $field > $sdir/MAXRATE;;
		3) echo $field > $sdir/RESOLUTION;;
		esac
		let ii=$ii+1
		if [ $ii -eq 2 -a "$M" != "01" ]; then
			# next fields valid ACQ420 only
			break;
		fi
	done
	IFS=$_IFS			

	grep -q FRU_PROD_NAME $details
	if [ $? -eq 0 ]; then
		decode_fru_success=1
		echo OK;
	else
		echo FAIL;
	fi

	chmod 444 ${sdir}/*
}

good_sites=""

for sd in /dev/sites/?
do
	if [ -d $sd ]; then
		site=$(basename $sd)
		SITES=$(aappend $SITES $site)
		fru-dump-acq ${sd}/eeprom > ${sd}/details
	
		decode_fru_success=0
		decode_fru $site ${sd}/details
		if [ $decode_fru_success -ne 0 ]; then
			GOOD_SITES=$(aappend $GOOD_SITES $site)
			good_sites="$good_sites $site"
		fi
	fi
done

#echo SITES \"$SITES\"
#echo GOOD_SITES \"$GOOD_SITES\"
#echo good_sites \"$good_sites\"


get_mtype()
{
	if [ -e /etc/acq400/$1/MTYPE ]; then
		cat /etc/acq400/$1/MTYPE
	else
		echo ff
	fi
}

is_gzip_file() {
	echo $1 | grep -q \.gz$
}
# omit underscore
ideal_fpga=${FMC_SCAN_FPGA}TOP

for site in $FMC_SCAN_SITES
do
	ideal_fpga="${ideal_fpga}_$(get_mtype $site)"
done




fpga_image_good=""

get_fspec() {
	if [ -r $1 ]; then
		is_gzip_file $1
		if [ $? -eq 0 ]; then
			fspec=$(gunzip -c $1 | get_fpga_spec -i -)
		else
			fspec=$(get_fpga_spec $1)
		fi
		echo $fspec
	fi
}
test_compatible_bitfile() {
	fspec=$1
	if [ "x$fspec" != "x" ]; then
		is_compatible_bitfile $ideal_fpga $fspec quiet
		if [ $? -eq 0 ]; then
			echo +++ compatible bitfile $fspec
			fpga_image_good=$1
		fi
	fi		
}

test_identical_bitfile() {
	if [ "x$ideal_fpga" = "x$1" ]; then
		echo +++ identical bitfile
		fpga_image_good=$1
	fi
}

FPGA_STATUS=/tmp/fpga_status

fpga_check() {
        grep filename $FPGA_STATUS | awk '{ print $5 }'
        grep date $FPGA_STATUS |  awk '{print $3}'
}

load_fpga() {
	fpga_image_good=$1
	echo load FPGA $fpga_image_good
	echo load.fpga loaded $fpga_image_good >$FPGA_STATUS
	is_gzip_file $fpga_image_good
	if [ $? -eq 0 ]; then
		gunzip -c $fpga_image_good | \
			/bin/xiloader -L 2>>$FPGA_STATUS
	else
		/bin/xiloader -L $fpga_image_good 2>>$FPGA_STATUS
	fi
	echo $(fpga_check) > /etc/acq400/0/fpga_version
	if [ $? -ne 0 ]; then
		echo "ERROR FPGA load failed launch emergency shell"
		/bin/sh
	fi	
}

if [ "x$PREFERRED_BITFILE" != "x" ]; then
	if [ -a -e $PREFERRED_BITFILE ]; then
	 	test_compatible_bitfile $(get_fspec $PREFERRED_BITFILE)
		if [ "x$fpga_image_good" != "x" ]; then
			load_fpga $PREFERRED_BITFILE
		fi
	fi
fi

if [ "x$fpga_image_good" = "x" -a $module_count != 0 ]; then
	for file in /mnt/${FMC_SCAN_FPGA}*.bit* \
			/mnt/fpga.d/${FMC_SCAN_FPGA}*.bit*
	do
		test_identical_bitfile $(get_fspec $file)
		if [ "x$fpga_image_good" != "x" ]; then
			load_fpga $file
			break
		fi
	done
fi

if [ "x$fpga_image_good" = "x" -a $module_count != 0 ]; then
	for file in /mnt/${FMC_SCAN_FPGA}*.bit* \
		$(ls /mnt/fpga.d/${FMC_SCAN_FPGA}*.bit* | sort -r)
	do
		test_compatible_bitfile $(get_fspec $file)
		if [ "x$fpga_image_good" != "x" ]; then
			load_fpga $file
			break
		fi
	done
fi

if [ "$fpga_image_good" = "" ]; then
	echo ERROR: no valid FPGA image found, FPGA NOT LOADED
	exit	
fi 

for site in $good_sites
do	
	set.sys /dev/gpio/LED/FMC${site}_R 0
	set.sys /dev/gpio/LED/FMC${site}_G 1
	let site_count=$site_count+1
done

echo $SITES > /etc/sites
echo $GOOD_SITES >>/etc/sites

source /etc/sites

SEP=""
SITELIST=""
eval $SITES
for site in 0 $(echo $sites | tr ,C \  )
do
	model=$(cat /etc/acq400/$site/MODEL | tr -d [A-Za-z] | awk '{ print $1 }')
	SITELIST="${SITELIST}${SEP}${site}=${model}"
	SEP=","
done

echo "$SITELIST" >/etc/acq400/0/SITELIST

if [ "x$sites" = "x$good_sites" ]; then
	echo ++ Sites populated: $site_count ALL GOOD
else
	echo ++ Sites populated: $site_count WARNING: FOUND:$sites GOOD:$good_sites
fi

echo done > $scan_done

